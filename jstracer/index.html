<!DOCTYPE html>
<html>

<head>
  <title>JSRay</title>
</head>

<body>
  <canvas style="width: 800px; height: 600px; background-color: #000;" width="800" height="600" id="myCanvas">
  </canvas>
  <br />
  <textarea id="scene-data" style="position: fixed; top: 600px; left: 0; right: 0; bottom: 0;" spellcheck="false">

let chessboard = { 
    shape: "plane", 
    normal: [0,1,0], 
    distance: 0,
    texture: { 
      pigment: {
        pattern: "tiles",
        color1: "#000",
        color2: "#fff"
      }
    }
 }    
let scene = {  
  camera: { position: [-2,3,-10], look_at: [0,0,0] },
  lights: [
    { position: [-10,10,0 ], color: [1,0,0] },
    { position: [0,10,-10 ], color: "#0f0" },
    { position: [10,10,0 ], color: "#00f" },  
  ],
  shapes: [
  { shape: "sphere", position: [0,1,0], radius: 1, texture: { 
    finish: { reflection: 0.5 } 
  } },
  { shape: "sphere", position: [0,2.5,0], radius: 0.5 },
  chessboard
  ]
}
</textarea>
  <button id="goButton">GO</button>
  <button id="stopButton">STOP</button>
</body>
<script type="module">
  function makeHandler(canvas) {
    var ctx = canvas.getContext('2d');
    return function (e) {
      switch (e.data.message) {
        case 'row':
          let step = e.data.step;
          var index = 0;
          for (var x = 0; x < canvas.width; x += step) {
            let color = `rgb(${e.data.row[index++]},${e.data.row[index++]},${e.data.row[index++]})`;
            ctx.fillStyle = color;
            ctx.fillRect(x, e.data.y, step, step);
          }
          break;
      }
    };
  }
  function go() {
    let sceneData = document.getElementById('scene-data').innerHTML;
    sceneData = eval(`${sceneData}; scene;`);
    let canvas = document.getElementById('myCanvas');
    var ctx = canvas.getContext('2d');
    ctx.fillStyle = "#000";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    window.worker = new Worker('worker.js', { type: "module" });
    window.worker.addEventListener('message', makeHandler(canvas));
    window.worker.postMessage({ command: 'start', scene: sceneData, width: canvas.width, height: canvas.height });
  }
  let ready = (fn) => (document.readyState != 'loading' ? fn() : document.addEventListener('DOMContentLoaded', fn));
  ready(go);
  document.getElementById('stopButton').addEventListener("click", () => {
    if (window.worker && window.worker.terminate) window.worker.terminate();
    delete window.worker;
  });
  document.getElementById('goButton').addEventListener("click", go);
</script>


</html>